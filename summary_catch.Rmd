---
title: "Catch dataset analysis (Global Tuna Atlas - IRD Level 2)"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)


```

```{r echo=TRUE, results='hide'}
packages <- c("qs", "dplyr", "ggplot2", "sf", "lubridate", "here", "ows4R", "patchwork", "kableExtra")
lapply(packages, function(pkg) {
  if (!require(pkg, character.only = TRUE)) install.packages(pkg)
  library(pkg, character.only = TRUE)
})
```


## ðŸ“¥ Download and load the file

### From qs (if you want to download geometry as well, it can be heavy)

```{r}

qs_file <- "global_catch_tunaatlasird_level2.qs"
if (!file.exists(qs_file)) {
  download.file("https://zenodo.org/record/15221705/files/global_catch_tunaatlasird_level2.qs?download=1", qs_file, mode = "wb")
}
catch_data <- qs::qread(qs_file)

catch_data$geom_wkt <- NULL 

```

### From csv (geometry can be downloaded from github, downloading is slower and the dataset is close to 1GB).

```{r}

csv_file <- "global_catch_tunaatlasird_level2 (without_geom).csv"
if (!file.exists(csv_file)) {
  download.file("https://zenodo.org/records/15221705/files/global_catch_tunaatlasird_level2%20(without_geom).csv?download=1", csv_file, mode = "wb")
}
catch_data <- readr::read_csv(csv_file) %>% dplyr::mutate(geographic_identifier = as.character(geographic_identifier))


```

## First lines


```{r}
kableExtra::kable(head(catch_data))
```

As the geometry can be heavy, we propose to remove it and to add it when necessary in plots.

## ðŸ“Š Data overview

This dataset provides monthly records of tuna and tuna-like species catches at the global scale between 1950 and 2021. Here is a description of the columns:

- `source_authority`: Regional Fisheries Management Organization (RFMO) that provided the data
- `fishing_fleet`: Code of the flag state or fleet (e.g., AUS, JPN)
- `time_start`, `time_end`: Start and end dates of the observation period (monthly granularity, sometimes annualy)
- `geographic_identifier`: Code identifying the spatial grid cell, from CWP grid dataset.
- `gear_type`: Code of the fishing gear used
- `species`: Species code (e.g., SBF for Southern Bluefin Tuna)
- `fishing_mode`: Code indicating the fishing mode
- `measurement_unit`: Unit used to report catches (e.g., Tons, Number)
- `measurement_value`: Numeric value of the measured catch
- `GRIDTYPE`: Spatial grid type (e.g., 1deg_x_1deg)
- `species_group`: Taxonomic group (e.g., SCOMBROIDEI)
- `gear_label`: Human-readable gear name
- `fishing_fleet_label`: Human-readable label for the flag or fleet
- `species_label`: Common name of the species
- `species_definition`: Scientific name of the species
- `geom_wkt`: Geometry in WKT format (MULTIPOLYGON)
- `ocean`: RFMO area of activity
<!-- - `fishing_mode_label`: Human-readable label for fishing mode -->

```{r}
dplyr::glimpse(catch_data)
```


```{r}
summary(catch_data$measurement_value)
```


```{r}
kableExtra::kable(table(catch_data$measurement_unit))
```


```{r message=FALSE, warning=FALSE, include=FALSE}
  cwp_grid_file <- here("data/cl_areal_grid.csv")
  if (!file.exists(cwp_grid_file)) {
    message("Downloading cl_area from github repo")
    zip_url <- "https://github.com/fdiwg/fdi-codelists/raw/main/global/cwp/cl_areal_grid.zip"
    zip_path <- here("data/cwp_grid.zip")
    download.file(zip_url, zip_path, mode = "wb")
    unzip(zip_path, exdir = here("data"))
  }
  cwp_grid <- st_read(cwp_grid_file)
  cwp_grid <- st_as_sf(
    cwp_grid,
    wkt = "geom_wkt",   
    crs = 4326         
  ) %>%
     dplyr::rename(cwp_code = CWP_CODE) %>%
    dplyr::rename(geom = geom_wkt)
  
qs_file <- "UN_CONTINENT2.qs"

if (!file.exists(qs_file)) {
  message("Downloading UN_CONTINENT2 from FAO GeoServer...")
  WFS <- WFSClient$new(
    url = "https://www.fao.org/fishery/geoserver/fifao/wfs",
    serviceVersion = "1.0.0",
    logger = "INFO"
  )
  continent <- WFS$getFeatures("fifao:UN_CONTINENT2")
  
  # Save to .qs for faster reloads later
  qs::qsave(continent, qs_file)
} else {
  message("Loading cached UN_CONTINENT2 from local file...")
  continent <- qs::qread(qs_file)
}
sf::st_crs(continent) <- 4326

```



## ðŸ—ºï¸ Catch map

This map shows the spatial distribution of catches or effort aggregated by geographic grid cell. The `measurement_value` is summed per area.

```{r}
catch_summary_by_unit <- catch_data %>%
  dplyr::group_by(geographic_identifier, measurement_unit) %>%
  dplyr::summarise(total = sum(measurement_value, na.rm = TRUE), .groups = "drop")

catch_summary_geom <- catch_summary_by_unit %>%
  dplyr::inner_join(cwp_grid %>% dplyr::select(cwp_code, geom), by = c("geographic_identifier" = "cwp_code")) %>%
  sf::st_as_sf()

plots <- catch_summary_geom %>%
  dplyr::group_split(measurement_unit) %>%
  purrr::map(function(df) {
    unit <- unique(df$measurement_unit)
    
    ggplot2::ggplot() +
      ggplot2::geom_sf(data = continent, fill = "gray90", color = "gray60") +
      ggplot2::geom_sf(data = df, ggplot2::aes(fill = total), color = NA) +
      ggplot2::scale_fill_viridis_c(option = "plasma", trans = "log", na.value = "transparent") +
      ggplot2::labs(title = paste("Unit:", unit), fill = "Catch Total") +
      ggplot2::theme_minimal()
  })

patchwork::wrap_plots(plots, ncol = 2)


```

## ðŸ“ˆ Annual catch trends

```{r}

catch_data %>%
  dplyr::group_by(year = lubridate::year(time_start), measurement_unit) %>%
  dplyr::summarise(total = sum(measurement_value, na.rm = TRUE)) %>%
  ggplot2::ggplot(ggplot2::aes(x = year, y = total)) +
  ggplot2::geom_line() +
  ggplot2::facet_wrap(~measurement_unit, scales = "free_y") +
  ggplot2::labs(title = "Total catches by Year and Measurement unit", y = "Measured Value", x = "Year")


```


# Your turn:

If you want to use only part of the data you can filter the dataset using the dimensison provided exemple, here let's focus on silky sharks (note that this only concern catch data as effort cannot be related to species)

```{r}

silky_sharks <- catch_data %>% dplyr::filter(species_label == "Silky shark")

```

```{r}

silky_sharks %>%
  dplyr::group_by(year = lubridate::year(time_start), measurement_unit) %>%
  dplyr::summarise(total = sum(measurement_value, na.rm = TRUE)) %>%
  ggplot2::ggplot(ggplot2::aes(x = year, y = total)) +
  ggplot2::geom_line() +
  ggplot2::facet_wrap(~measurement_unit, scales = "free_y") +
  ggplot2::labs(title = "Total catches by Year and Measurement unit", y = "Measured Value", x = "Year")

```

## Let's decompose the data for some dimensions

```{r}

groupped_gear <- silky_sharks %>% dplyr::group_by(gear_label, time_start, measurement_unit) %>% 
  dplyr::summarise(measurement_value = sum(measurement_value))

ggplot(groupped_gear) +
  aes(
    x = time_start,
    y = measurement_value,
    colour = gear_label
  ) +
  geom_line() +  #
  geom_point() +
  scale_color_hue(direction = 1) +
  theme_minimal() +
  facet_wrap(vars(measurement_unit), scales = "free")


```


```{r, eval=FALSE}
groupped_fishing_fleet <- silky_sharks %>% dplyr::group_by(fishing_fleet_label, time_start, measurement_unit) %>% 
  dplyr::summarise(measurement_value = sum(measurement_value))

ggplot(groupped_fishing_fleet) +
  aes(
    x = time_start,
    y = measurement_value,
    colour = fishing_fleet_label
  ) +
  geom_line() +  #
  geom_point() +
  scale_color_hue(direction = 1) +
  theme_minimal() +
  facet_wrap(vars(measurement_unit), scales = "free")
```


```{r}
groupped_source_auth <- silky_sharks %>% dplyr::group_by(source_authority, time_start, measurement_unit) %>% 
  dplyr::summarise(measurement_value = sum(measurement_value))

ggplot(groupped_source_auth) +
  aes(
    x = time_start,
    y = measurement_value,
    colour = source_authority
  ) +
  geom_line() +  #
  geom_point() +
  scale_color_hue(direction = 1) +
  theme_minimal() +
  facet_wrap(vars(measurement_unit), scales = "free")


```

# How to aggregate data from 1 deg to 5 deg ? 

```{r}

source("https://raw.githubusercontent.com/firms-gta/geoflow-tunaatlas/master/sardara_functions/transform_cwp_code_from_1deg_to_5deg.R")

one_degree <- silky_sharks %>% dplyr::filter(substr(geographic_identifier, 1, 1) == "5")
five_degree <- silky_sharks %>% dplyr::filter(substr(geographic_identifier, 1, 1) == "6")
silky_sharks_aggregated <- one_degree %>% rowwise() %>% 
  dplyr::mutate(geographic_identifier = transform_cwp_code_from_1deg_to_5deg(geographic_identifier))




```


# How to disaggregate ? (need connection to DB for now)


```{r eval=FALSE, include=TRUE}

source("https://raw.githubusercontent.com/eblondel/geoflow-tunaatlas/master/tunaatlas_scripts/generation/spatial_curation_downgrade_resolution.R")

georef_dataset<-spatial_curation_downgrade_resolution(con,silky_sharks,resolution = 1 , remove = FALSE)

```

